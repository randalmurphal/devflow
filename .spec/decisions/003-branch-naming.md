# ADR-003: Branch Naming Conventions

## Status

Accepted

## Context

When devflow creates branches for automated workflows, we need consistent naming conventions that:

1. Identify automated branches vs human-created ones
2. Include context (ticket ID, workflow type)
3. Avoid conflicts with existing branches
4. Work across git hosting platforms

## Decision

### Branch Name Format

```
{type}/{identifier}[-{suffix}]
```

| Component | Description | Examples |
|-----------|-------------|----------|
| `type` | Branch category | `feature`, `bugfix`, `auto`, `devflow` |
| `identifier` | Unique identifier | `TK-421`, `issue-123`, `add-caching` |
| `suffix` | Optional disambiguation | timestamp, attempt number |

### Standard Types

| Type | When Used | Example |
|------|-----------|---------|
| `feature/` | New feature implementation | `feature/TK-421` |
| `bugfix/` | Bug fix | `bugfix/TK-422-auth-crash` |
| `devflow/` | Auto-generated by devflow | `devflow/TK-421-1734567890` |
| `refactor/` | Code refactoring | `refactor/extract-auth-service` |
| `docs/` | Documentation changes | `docs/update-readme` |

### Naming Rules

1. **Lowercase**: All branch names are lowercase
2. **Alphanumeric + hyphens**: Only `a-z`, `0-9`, `-`, `/`
3. **No consecutive hyphens**: `feature--test` → `feature-test`
4. **No trailing hyphens**: `feature-test-` → `feature-test`
5. **Max length**: 100 characters

### Auto-Generated Branches

When devflow generates branches automatically, use the `devflow/` prefix with timestamp:

```
devflow/TK-421-1734567890
devflow/ticket-to-pr-TK-421-1734567890
```

This prevents conflicts if the workflow runs multiple times.

### From Ticket/Issue

When creating from a ticket:

```go
func BranchFromTicket(ticketID, title string) string {
    // Sanitize title
    slug := slugify(title)  // "Add User Authentication" → "add-user-authentication"

    // Truncate if needed
    if len(slug) > 50 {
        slug = slug[:50]
    }

    return fmt.Sprintf("feature/%s-%s", strings.ToLower(ticketID), slug)
}

// Examples:
// TK-421, "Add User Authentication" → feature/tk-421-add-user-authentication
// TK-422, "Fix login bug"          → feature/tk-422-fix-login-bug
```

### From Workflow

When creating from a workflow run:

```go
func BranchFromWorkflow(workflowID, runID string) string {
    return fmt.Sprintf("devflow/%s-%s", workflowID, runID)
}

// Examples:
// "ticket-to-pr", "run-2025-01-15-001" → devflow/ticket-to-pr-run-2025-01-15-001
```

## Alternatives Considered

### Alternative 1: UUID Suffixes

Use UUIDs instead of timestamps: `devflow/TK-421-a1b2c3d4`

**Rejected because:**
- Harder to read
- Can't sort chronologically
- No advantage over timestamp

### Alternative 2: No Type Prefix

Just use identifier: `TK-421-add-auth`

**Rejected because:**
- Harder to filter automated branches
- Conflicts with human branch conventions
- Less organized

### Alternative 3: User-Based Prefix

Include username: `user/bob/feature/TK-421`

**Rejected because:**
- devflow is automated, no user
- Adds complexity
- Not needed for our use case

## Consequences

### Positive

- **Predictable**: Branch names are deterministic
- **Sortable**: Timestamps allow chronological sorting
- **Filterable**: Type prefix enables filtering automated branches
- **Readable**: Human-readable identifiers and slugs

### Negative

- **Length**: Full names can be long
- **Strictness**: May conflict with existing team conventions
- **Timestamp collisions**: Possible if same ticket processed same second

### Configuration

Allow overriding defaults:

```go
type BranchConfig struct {
    TypePrefix    string // Override default type (e.g., "auto" instead of "devflow")
    IncludeTitle  bool   // Whether to include title slug
    MaxLength     int    // Maximum branch name length
    Separator     string // Separator character (default "-")
}
```

## Code Example

```go
package devflow

import (
    "fmt"
    "regexp"
    "strings"
    "time"
)

// BranchNamer generates branch names following conventions
type BranchNamer struct {
    TypePrefix   string
    IncludeTitle bool
    MaxLength    int
}

// DefaultBranchNamer returns a namer with default settings
func DefaultBranchNamer() *BranchNamer {
    return &BranchNamer{
        TypePrefix:   "feature",
        IncludeTitle: true,
        MaxLength:    100,
    }
}

// ForTicket generates a branch name from a ticket
func (n *BranchNamer) ForTicket(ticketID, title string) string {
    parts := []string{
        n.TypePrefix,
        strings.ToLower(ticketID),
    }

    if n.IncludeTitle && title != "" {
        slug := slugify(title)
        if len(slug) > 50 {
            slug = slug[:50]
        }
        parts = append(parts, slug)
    }

    branch := strings.Join(parts[:1], "/") + "/" + strings.Join(parts[1:], "-")

    if len(branch) > n.MaxLength {
        branch = branch[:n.MaxLength]
    }

    return cleanBranch(branch)
}

// ForWorkflow generates a branch name for automated workflow
func (n *BranchNamer) ForWorkflow(workflowID, identifier string) string {
    timestamp := time.Now().Unix()
    branch := fmt.Sprintf("devflow/%s-%s-%d", workflowID, identifier, timestamp)

    if len(branch) > n.MaxLength {
        branch = branch[:n.MaxLength]
    }

    return cleanBranch(branch)
}

// slugify converts a title to a URL-safe slug
func slugify(s string) string {
    // Lowercase
    s = strings.ToLower(s)

    // Replace spaces with hyphens
    s = strings.ReplaceAll(s, " ", "-")

    // Remove non-alphanumeric except hyphens
    s = regexp.MustCompile(`[^a-z0-9-]`).ReplaceAllString(s, "")

    // Remove consecutive hyphens
    s = regexp.MustCompile(`-+`).ReplaceAllString(s, "-")

    // Trim hyphens from ends
    s = strings.Trim(s, "-")

    return s
}

// cleanBranch ensures branch name is valid
func cleanBranch(s string) string {
    // Remove consecutive hyphens
    s = regexp.MustCompile(`-+`).ReplaceAllString(s, "-")

    // Remove trailing hyphens
    s = strings.TrimRight(s, "-")

    return s
}
```

### Usage

```go
namer := devflow.DefaultBranchNamer()

// From ticket
branch := namer.ForTicket("TK-421", "Add User Authentication")
// → "feature/tk-421-add-user-authentication"

// For automated workflow
branch = namer.ForWorkflow("ticket-to-pr", "TK-421")
// → "devflow/ticket-to-pr-tk-421-1734567890"

// Custom configuration
namer = &devflow.BranchNamer{
    TypePrefix:   "auto",
    IncludeTitle: false,
    MaxLength:    60,
}
branch = namer.ForTicket("TK-421", "Add User Authentication")
// → "auto/tk-421"
```

## References

- [Git Branch Naming Best Practices](https://git-scm.com/docs/git-check-ref-format)
- ADR-001: Worktree Strategy (branch names become directory names)
