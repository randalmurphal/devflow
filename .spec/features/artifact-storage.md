# Feature: Artifact Storage

## Overview

Store and manage files generated during workflow execution.

## Use Cases

1. **Save specifications**: Store generated specs for reference
2. **Store diffs**: Keep implementation diffs
3. **Store reviews**: Save review results
4. **Generated files**: Store code generated by Claude

## API

### Save Artifact

```go
manager := devflow.NewArtifactManager(devflow.ArtifactConfig{
    BaseDir: ".devflow",
})

err := manager.SaveArtifact(runID, "spec.md", []byte(specContent))
```

### Load Artifact

```go
data, err := manager.LoadArtifact(runID, "spec.md")
```

### List Artifacts

```go
artifacts, err := manager.ListArtifacts(runID)
for _, a := range artifacts {
    fmt.Printf("%s: %d bytes (compressed: %v)\n", a.Name, a.Size, a.Compressed)
}
```

### Type-Specific Helpers

```go
// Save review result
err := manager.SaveReview(runID, &ReviewResult{
    Approved: false,
    Findings: []Finding{...},
})

// Load review result
review, err := manager.LoadReview(runID)
```

## Directory Structure

```
.devflow/runs/
└── 2025-01-15-ticket-to-pr-TK421/
    ├── metadata.json
    ├── transcript.json
    └── artifacts/
        ├── spec.md           # Generated specification
        ├── implementation.diff # Code changes
        ├── review.json       # Review results
        ├── test-output.json  # Test results
        └── files/            # Generated files
            ├── api.go
            └── api_test.go
```

## Standard Artifact Types

| Artifact | Filename | Format |
|----------|----------|--------|
| Specification | `spec.md` | Markdown |
| Implementation diff | `implementation.diff` | Unified diff |
| Review results | `review.json` | JSON |
| Test output | `test-output.json` | JSON |
| Lint output | `lint-output.json` | JSON |

## Compression

Files are automatically compressed when:
- Size >= `CompressAbove` threshold (default 10KB)
- File type is compressible (not images)

```go
manager := devflow.NewArtifactManager(devflow.ArtifactConfig{
    BaseDir:       ".devflow",
    CompressAbove: 10 * 1024, // 10KB
})
```

Compressed files are stored with `.gz` extension but loaded transparently.

## Lifecycle Management

```go
lifecycle := devflow.NewLifecycleManager(".devflow", devflow.RetentionConfig{
    RetentionDays:       30,  // Keep active runs for 30 days
    ArchiveAfterDays:    7,   // Archive after 7 days
    ArchiveRetentionDays: 90, // Keep archives for 90 days
    KeepFailed:          true, // Keep failed runs longer
})

// Dry run
result, _ := lifecycle.Cleanup(true)
fmt.Printf("Would archive: %v\n", result.Archived)
fmt.Printf("Would delete: %v\n", result.Deleted)

// Actually clean up
result, _ := lifecycle.Cleanup(false)
```

## Example

```go
manager := devflow.NewArtifactManager(devflow.ArtifactConfig{
    BaseDir: ".devflow",
})

runID := "2025-01-15-ticket-to-pr-TK421"

// Save spec
spec := `# Technical Specification
...
`
manager.SaveArtifact(runID, "spec.md", []byte(spec))

// Save review
manager.SaveReview(runID, &devflow.ReviewResult{
    Approved: false,
    Summary:  "Found 2 issues",
    Findings: []devflow.ReviewFinding{
        {
            File:     "api.go",
            Line:     45,
            Severity: "error",
            Message:  "Missing error handling",
        },
    },
})

// Later: load review
review, _ := manager.LoadReview(runID)
if !review.Approved {
    fmt.Printf("Review found %d issues\n", len(review.Findings))
    for _, f := range review.Findings {
        fmt.Printf("  %s:%d - %s\n", f.File, f.Line, f.Message)
    }
}

// List all artifacts
artifacts, _ := manager.ListArtifacts(runID)
fmt.Println("\nArtifacts:")
for _, a := range artifacts {
    fmt.Printf("  %s (%d bytes)\n", a.Name, a.Size)
}
```

## CLI Commands

```bash
# List artifacts for a run
devflow artifact list run-2025-01-15-001

# View artifact
devflow artifact view run-2025-01-15-001 spec.md

# Export artifact
devflow artifact export run-2025-01-15-001 spec.md > spec.md

# Cleanup old runs
devflow cleanup --dry-run
devflow cleanup
```

## Testing

```go
func TestArtifactStorage(t *testing.T) {
    dir := t.TempDir()
    manager := devflow.NewArtifactManager(devflow.ArtifactConfig{
        BaseDir: dir,
    })

    runID := "test-run"

    // Save
    err := manager.SaveArtifact(runID, "test.txt", []byte("Hello, World!"))
    require.NoError(t, err)

    // Load
    data, err := manager.LoadArtifact(runID, "test.txt")
    require.NoError(t, err)
    assert.Equal(t, "Hello, World!", string(data))

    // List
    artifacts, err := manager.ListArtifacts(runID)
    require.NoError(t, err)
    assert.Len(t, artifacts, 1)
    assert.Equal(t, "test.txt", artifacts[0].Name)
}
```

## References

- ADR-015: Artifact Structure
- ADR-016: Artifact Lifecycle
- ADR-017: Artifact Types
